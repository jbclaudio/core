<script>
import {
    ReactiveBase,
    ReactiveList,
    ReactiveComponent,
    SelectedFilters,
    MultiList,
    DynamicRangeSlider,
} from '@appbaseio/reactivesearch-vue'
import VueSlider from 'vue-slider-component'

Vue.use(ReactiveBase)
Vue.use(ReactiveList)
Vue.use(ReactiveComponent)
Vue.use(SelectedFilters)
Vue.use(MultiList)
Vue.component('vue-slider-component', VueSlider)
Vue.use(DynamicRangeSlider)

export default {
    props: {
        additionalFilters: {
            type: Array,
            default: () => [],
        },
        additionalSorting: {
            type: Array,
            default: () => [],
        },
    },

    data: () => ({
        loaded: false,
        attributes: [],
        pageSize: Turbo.navigator.location.searchParams.get('pageSize') || config.grid_per_page
    }),

    render() {
        return this.$scopedSlots.default(Object.assign(this, { self: this }))
    },

    mounted() {
        if (localStorage.attributes) {
            this.attributes = JSON.parse(localStorage.attributes)
            this.loaded = true
            return
        }

        axios
            .get(window.url('/api/attributes'))
            .then((response) => {
                this.attributes = response.data
                localStorage.attributes = JSON.stringify(this.attributes)
                this.loaded = true
            })
            .catch((error) => {
                Notify(window.config.errors.wrong, 'error', error.response.data?.parameters)
            })
    },

    computed: {
        filters: function () {
            return window.sortBy(
                window.filter(this.attributes, function (attribute) {
                    return attribute.filter
                }),
                'position',
            )
        },
        sortings: function () {
            return window.filter(this.attributes, function (attribute) {
                return attribute.sorting
            })
        },
        reactiveFilters: function () {
            return window
                .map(this.filters, function (filter) {
                    return filter.code
                })
                .concat(this.additionalFilters)
        },
        sortOptions: function () {
            return [
                {
                    label: window.config.translations.relevance,
                    dataField: '_score',
                    sortBy: 'desc',
                },
            ]
                .concat(
                    window.flatMap(this.sortings, function (sorting) {
                        return window.map(
                            {
                                asc: window.config.translations.asc,
                                desc: window.config.translations.desc,
                            },
                            function (directionLabel, directionKey) {
                                return {
                                    label:
                                        window.config.translations.sorting?.[sorting.code]?.[directionKey] ??
                                        sorting.name + ' ' + directionLabel,
                                    dataField: sorting.code + (sorting.code != 'price' ? '.keyword' : ''),
                                    sortBy: directionKey,
                                }
                            },
                        )
                    }),
                )
                .concat(this.additionalSorting)
        },
    },
    watch: {
        pageSize: function (pageSize) {
            let url = new URL(window.location)
            url.searchParams.set('pageSize', pageSize)
            window.history.pushState(window.history.state, '', url)
        }
    }
}
</script>
